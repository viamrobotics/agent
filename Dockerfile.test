FROM golang:1.23.1

# Install required system packages
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy everything at once to preserve module structure
COPY . .

# Download dependencies
RUN go mod download

# Create a shell script to run tests
RUN echo '#!/bin/sh\n\
if [ -n "$TEST_TARGET" ]; then\n\
    go test -race -v ./... -run "^$TEST_TARGET\$"\n\
else\n\
    go test -race -v ./...\n\
fi' > /app/run-tests.sh && chmod +x /app/run-tests.sh

# Run tests
CMD ["/app/run-tests.sh"] 